Algorithms for Consistent Tailoring of the Synthetic Natural EnvironmentHaig IskenderianTodd D. SchwebachSteve O. OuztsNorthrop Grumman Information Technology55 Walkers Brook DriveReading, MA 01867-3297781-942-2000, Fax 781-942-2571 HYPERLINK "mailto:hiskenderian@tasc.com" hiskenderian@tasc.com,  HYPERLINK "mailto:tdschwebach@tasc.com" tdschwebach@tasc.com, HYPERLINK mailto:soouzts@tasc.com soouzts@tasc.comKeywords:Synthetic Natural Environments, User-controlled weather, Environmental Tailoring, Tailoring FrameworkABSTRACT: The Environmental Tailoring System (ETS) is a software tool for editing environmental data either prior to an exercise or during run-time. The ETS incorporates algorithms, known as the Pressure Field Modification (PFM) scheme, to accept user inputs such as edit variable, edit value, and the spatial and temporal extent of the edit, and make the modifications to the data while preserving a scientifically valid correlation between atmospheric variables.  Through the DMSO-sponsored Environment Federation project, the PFM algorithms have been expanded upon to allow for editing of precipitation and resulting changes in cloudiness.This paper will present (a) an overview of the meteorological principles behind the PFM editing algorithms, (b) a description of the recent extensions to PFM that support precipitation editing, and c) a discussion of the fundamental limitations of PFM.1. IntroductionTailoring tools are required to make detailed adjustments to a Synthetic Natural Environment (SNE) prior to an exercise.  In addition, such tools can allow the scenario to be steered at run-time to assure that the training experience meets specific goals. Without proper guidance, however, there is the potential that such adjustments will violate basic physical constraints and correlations as well as generating unanticipated results that are counterproductive to the overall training experience.Because simulations and their operators need data and products that are consistent with and derived from a common SNE, any tools used to edit the Synthetic Natural Environment (SNE) must assure an appropriate level of physical consistency across all five dimensions (time, 3-D space, and variable).  One basic task is to develop algorithms that will take changes to the SNE and consistently reflect those changes through the rest of the SNE data at an appropriate level of scientific validity.SNE tailoring is already seen as a critical element of scenario construction [1,2].  Tools which allow for scientifically valid adjustments to the Synthetic Natural Environment (SNE) will assist the Modeling and Simulation (M&S) community in two ways.  First, editing tools will allow for the adjustment of the SNE during the construction of the scenario (pre-exercise).  This can be very useful if the gridded data gathered according to some set of scenario requirements does not exactly meet those requirements.  Tailoring algorithms can then be used to modify a small portion of the SNE to meet a specific goal, blend those changes with adjacent regions and times, and leave the remaining data unchanged.  Second, tailoring tools can provide for short-notice changes to the SNE during the exercise itself (during run-time).  This is more of a challenge than editing during scenario construction in that run-time editing tools require not only physical consistency, but also the ability to operate efficiently across a distributed simulation. There is always a delicate balance between the complexity of physics and the computational expense of adhering to those physics. In this paper, the editing algorithms are described.  Section 2 discusses the edit definition process. Section 3 describes the editing algorithms for three-dimensional atmospheric variables and precipitation.  Section 4 provides an example of a precipitation edit, and Section 5 discusses some limitations of the PFM approach.Definition of the EditBefore discussing the details of the tailoring algorithm, it is appropriate first to review some of the basic terminology used in environmental editing.A variable edit is a user-specified change to the environmental scenario within some three-dimensional region, whether it be a priori (pre-exercise) or during run-time.  Typically, the edit is applied to one variable at a set of grid points within an elliptical subdomain.     The variable edit serves as the starting point from which the algorithm modifies some portion of the SNE.The three-dimensional region defined by the variable edit is termed the edit region.  Data lying away from the edit location must be blended with edited data at the edit location to provide a smooth spatial transition within the edit region.  The amount of blending at a given location is determined by a linear weighting function,  EMBED Equation.3  .  These modifications are called spatial blends.The time at which the edit takes place is the edit time.    Data lying within the edit region but at SNE times other than the edit time are blended with the edited data to assure a smooth temporal transition through the edit.  The amount of blending at a given time is determined by a linear weighting function,  EMBED Equation.3  .  These modifications to the SNE made by the algorithms are called temporal blends.Data within that region that is coupled to the edit variable due to its physical relationship to the edited variable must be modified to guarantee proper physical consistency.  These changes made to the SNE by the algorithms are termed correlated edits.A blended variable,  EMBED Equation.3  , is created at a given location in the edit region to reflect the total effect of the temporal and spatial weighting functions according to Eq. 1.   EMBED Equation.3  (1) EMBED Equation.3   is the original (unedited) value of the variable at a given location in the edit region,  EMBED Equation.3   is the value of the variable at the edit location, and  EMBED Equation.3  is the original value of the variable at the edit location.The algorithms typically make modifications to the SNE in the following order: (1) spatial blends, (2) temporal blends, and (3) correlated edits.  Though the variable edit is accepted as the user’s requirement and is not modified, the algorithm may provide guidance if the edit violates some basic physical or statistical constraint.Edit relationshipsThe following section describes the algorithms used to edit three-dimensional atmospheric variables and the two-dimensional field of precipitation.3D variablesThe user has the option to edit the following variables: Temperature, pressure, relative humidity, u-wind component, v-wind compont, and wind direction and speed.  A temperature edit is described below to illustrate the algorithms used to perform an edit.  Edits to the other variables are performed in a similar manner through algebraic manipulations of these algorithms.Upon requesting a temperature edit, the temperature field is first blended in space and time in the edit region to produce the blended temperature field,  EMBED Equation.3  .  The correlation sequence following the blending is to first correlate temperature to the pressure field, then relative humidity, then the geostrophic wind components and finally the wind speed and direction.  To correlate pressure with  EMBED Equation.3  , Poisson’s equation is solved for  EMBED Equation.3  , the correlated pressure: EMBED Equation.3  				(2)where  EMBED Equation.3   and  EMBED Equation.3   are the original unedited pressure and temperature,  EMBED Equation.3   is the blended temperature field, and EMBED Equation.3     EMBED Equation.3    EMBED Equation.3  The correlated relative humidity field,  EMBED Equation.3  , is related to  EMBED Equation.3   by calculating the saturation vapor pressure of the original field in hPa,  EMBED Equation.3  , from Teten’s formula: EMBED Equation.3  			(3)where a=7.5, b = 237.3 for T  ≥ 0 C, and a = 9.5, b = 265.5 for T < 0 C.  The original vapor pressure in hPa,  EMBED Equation.3  , is given by: EMBED Equation.3  				(4) EMBED Equation.3  The correlated field of saturation vapor pressure,  EMBED Equation.3  , is computed from  EMBED Equation.3   according to Eq. 3.  The correlated relative humidity,  EMBED Equation.3  , is expressed as: EMBED Equation.3  			(5)The wind components are then correlated to the pressure according to the equations for the geostrophic wind components on height coordinates: EMBED Equation.3  			(6)and EMBED Equation.3  			(7)The Coriolis parameter, f, is: EMBED Equation.3  				(8)where  EMBED Equation.3  =2.292 X 10-5 is the angular velocity of the earth’s rotation and  EMBED Equation.3   is latitude.The correlated wind speed,  EMBED Equation.3  , is calculated as: EMBED Equation.3  			(9)Finally, the wind direction, D, is correlated with the correlated u and v fields.  EMBED Equation.3   u < 0, v < 0 EMBED Equation.3  u > 0, v < 0				(10) EMBED Equation.3  u < 0, v > 0 	  EMBED Equation.3   u > 0, v > 0Precipitation editUnlike other PFM-based edits where the edited variable is correlated with other state variables through physical equations, precipitation edits will be correlated with related variables through a statistical approach.  A statistical approach is necessary because there exists no simple physical relationship between precipitation and relative humidity, cloud height, and/or cloud amount.Regression equations are used to establish empirical relationships between precipitation-related variables in the input scenario.  From these regressions, a requested change in precipitation rate within the edit region is related to changes in the height of low cloud top, low cloud base, and low cloud amount.  (Only low cloud characteristics are changed in the case of a precipitation edit.)  The total accumulated precipitation and accumulated precipitation over the previous time step are adjusted to reflect the requested change in precipitation rate.  The relative humidity within the cloud layer is adjusted to be consistent with the adjusted precipitation rate, and the remaining volumetric variables, such as temperature, wind and pressure, are correlated to the adjusted relative humidity field via the basic PFM algorithms.  Details of the method follow.A precipitation edit begins by calculating the number of grid points, N, in the edit region and over all edit times that contain precipitation rates exceeding 0.25 mm hr-1 and containing low cloud.  If N > 30, the database contains the minimum number of data samples to construct a meaningful statistical relationship, and the statistical approach is used.  If N <= 30, then the user will be prompted to use a block edit of precipitation.Assuming that the database contains at least 30 data samples, the level of maximum relative humidity, Hmax,, between the surface and the top of the low cloud is found at the edit location.  This level, LHmax,, will serve as the edit level for correlation with the 3D atmospheric variables such as temperature, winds, and pressure with relative humidity.  Next, the change in precipitation rate,  EMBED Equation.3  , is computed by differencing the edited value of precipitation rate with the original value at the edit location.Next, linear regression relationships are derived between:1. PR and Hmax 2. PR and Low cloud base (LCB)3. PR and Low cloud top (LCT)4. PR and Low cloud thickness (LCZ = LCT – LCB)5. PR and Low cloud amount (LCA)from the simple linear regression equation: EMBED Equation.3  				(11)where  EMBED Equation.3   is the dependent variable [in this case Hmax, LCB, LCT, or LCA] and x is the independent variable [PR].The computational procedure to find a and b is: EMBED Equation.3  			(12) EMBED Equation.3  				(13)where  EMBED Equation.3   and  EMBED Equation.3  .Next, the vertical extent, Z, of the relative humidity edit is found based on predicted vertical extent of the cloud for the value of the edited precipitation rate at the edit location: EMBED Equation.3  			(14)The precipitation rate edit is blended in space and time via standard PFM procedure. EMBED Equation.3  		(15)The blended precipitation must be ≥ 0.Depending on whether clouds exist at a given point in the edit domain, one of two approaches is used to correlate clouds with the blended precipitation. In either case, a cloud must have a minimum thickness of 100 m and the cloud base cannot be lower than 0 m or higher than 12000 m.After the clouds are adjusted to the blended precipitation rate, the accumulated precipitation (AP) and accumulated precipitation per time step (APDT) are adjusted for the blended precipitation rate.  First, the time step DT in the database in units of hours is determined.  Then, APDT is adjusted at each time and point in the edit region according to: EMBED Equation.3  			(16)AP at each time and point in the edit region is adjusted according to: EMBED Equation.3  			(17)Next, the relative humidity field is blended in space and time to reflect the precipitation rate edit according to: EMBED Equation.3  		(18)where the level of the edit is given by LHmax and the value of Z from Eq. 14 is used to specify the vertical extent of the edit.If there is a cloud present at a location, the relative humidity within the cloud cannot be less than 70%.  The other state variables are correlated with the blended relative humidity field through the standard PFM procedure for a relative humidity edit.3.2.1  Pre-existing cloud at the pointIf the blended value of precipitation rate is greater than zero, and a low cloud exists at the point, we use the value of  EMBED Equation.3   from the regression equation for precipitation rate and LCB to determine the change in the height of the existing low cloud base: EMBED Equation.3   	(19)Similarly,  EMBED Equation.3  	(20) EMBED Equation.3  	(21)3.2.2  No pre-existing cloud at the pointIf the blended value of precipitation rate is greater than zero, and a low cloud does not exist at the point, a cloud must be produced at that point.  We use the value of  EMBED Equation.3  and  EMBED Equation.3   from the regression equation for precipitation rate and LCB to predict the height of the low cloud base based on  EMBED Equation.3  : EMBED Equation.3  			(22)Similarly, we predict the height of the low cloud top and low cloud amount as: EMBED Equation.3  			(23) EMBED Equation.3  			(24)4.  Application of the AlgorithmTo display an example of a precipitation edit, a scenario is generated for a 24 hour period with state data saved every 20 minutes.  The domain is 100 km X 100 km centered over Camp Pendleton, CA, and the grid spacing is 3 km.  The algorithm is tested using an edit to the precipitation rate with a magnitude of 35 mm hr-1 at a location of 33.8 N 117.5 W.  The original value of the precipitation rate at the center of the edit region is about 4 mm hr-1. Figure 1 shows the location of the precipitation edit. EMBED MSPhotoEd.3  Figure 1.  Edited (top) and unedited (bottom) precipitation rate (mm hr-1).  Location of the edit region is shown by the oval on the top figure.The pre- and post- low cloud amount fields are shown in Figure 2.  There is a general region of no cloudiness in the edit region prior to the edit.  After the edit, the clouds have been filled in to account for the precipitation that has been added to the data base as a result of the edit.  After adjusting the cloud field to satisfy the requirement for additional precipitation around the edit location, the relative humidity field is adjusted to account for the clouds, and the remainder of the 3D variables mentioned above is correlated with the adjusted relative humidity. EMBED MSPhotoEd.3  Figure 2.  Edited (top) and unedited (bottom) low cloud amount (%).  Location of the edit region is shown by the oval on the top figure.  5. Limitations of the algorithmsThe winds in the PFM algorithms are adjusted using the geostrophic relationships.  These relationships are most valid in the atmosphere for features on the synoptic scale (~ 1000 km).  For edit domains on the mesoscale (~100 km) and smaller, the geostrophic wind relationships may yield unreasonably large wind speeds for even a small perturbations of the other state variables. Further, the PFM algorithms correlate the atmospheric variables in a limited depth in the atmosphere.  In reality, the atmosphere tends to be vertically coupled, that is, the effects of an anomaly are not limited to a pre-defined depth.6.  References[1]	Whitney, D. A., et al.: “TAOS: Providing and Managing Realistic Natural Environments for Virtual Worlds”, Proceedings of the Fall Simulation Interoperability Workshop, September 1997.[2] Whitney, D. A., et al. “Virtual Natural Environments for the 21st Century”, Proceedings of the I/ITSEC Conference, 1998.AcknowledgmentsThis work was sponsored by the Defense Modeling and Simulation Office (DMSO).Author BiographiesHAIG ISKENDERIAN is an atmospheric scientist and the technical lead for the atmospheric data tailoring system for the ENVIROFED project.  Dr. Iskenderian received a B.S., M.S. and Ph.D. from the State University of New York at Albany.TODD D. SCHWEBACH is an atmospheric scientist and software programmer with a B. S. in Meteorology and a B. S. in Computer Science from Iowa State University.STEVE O. OUZTS, a retired US Air Force Colonel, has over 25 years experience in meteorology, space operations, modeling and simulation, and remote sensing. He has a B.S. from Auburn University, a M.S. in Atmospheric Dynamics from the Naval Postgraduate School, and an M.B.A. from the University of Nebraska.No cloud