Recommendations for Conducting an Exercise through a FirewallGerald M. SantosJohn M. Repko IINaval Undersea Warfare CenterNewport, RI 02841401-832-5800 HYPERLINK mailto:santosgm@npt.nuwc.navy.mil santosgm@npt.nuwc.navy.mil,   HYPERLINK mailto:repkojm@npt.nuwc.navy.mil repkojm@npt.nuwc.navy.milCynthia Drescher ArchambaultLogicon Inc.55 John Clarke RoadMiddletown, RI 02842401-849-6270 HYPERLINK mailto:cdrescher@logicon.com cdrescher@logicon.comKeywords:HLA, FirewallABSTRACT:   The HLA Federation TestBed Prototype set out to run a HLA exercise between Naval Undersea Warfare Center (NUWC) and Naval Research Laboratory (NRL) using RTI version 1.3v6.  In order to accomplish this task, three unclassified systems were to be set up in a Federation and connected via the Defense Research Engineering Network (DREN).  The DREN supports both classified (via cryptography devices) and unclassified network traffic.While NRL does not have a firewall, NUWC’s unclassified network segment has a firewall in place that prevents most unicast, multicast and broadcast traffic coming in from outside NUWC.   In order to get through the firewall, a trusted point-to-point connection was required and a multicast tunnel was created to send data between one system at NUWC and one system at NRL.  During tests of the configuration of the tunnel, it was determined that the RTI also sends TCP/IP traffic during the registration process.  The multicast tunnel does not allow TCP/IP traffic.  In order for the federates to set up a federation, the NUWC firewall needed to allow all TCP/IP traffic between both ends of the multicast tunnel. Additionally changes to the rid file were required to allow the federates operating on computers other than the authorized multicast computers to participate in the federation.The paper will explain the technical and policy issues faced to conduct an unclassified, plug and play exercise.1.  IntroductionThe High Level Architecture (HLA) Run Time Infrastructure (RTI) specification is the DoD standard for network interoperability between simulation systems. The specification is currently managed by Defense Modeling and Simulation Office (DMSO), which is also actively engaged in developing generic tools to test the performance of RTI implementations.  The Navy has become interested in expanding on these generic tools and procedures to create tools and procedures for Navy federation-specific testing.  As federations are developed, the performance of the RTI within the constraints of the specific federation needs to be quantified and understood. Small-scale HLA applications do not necessarily predict large-scale application performance.  The choke points of a particular network for specific interoperating federates need to be identified and procedures for mitigating their affect developed.  To this end, the Naval Undersea Warfare Center (NUWC) and Naval Research Laboratory (NRL) have teamed together to develop the Navy’s HLA Federation TestBed, designed to provide the Navy with the first steps toward attaining application-specific measurement tools and procedures.The Navy’s HLA Federation TestBed will contain a suite of performance measurement tools that can be used throughout the federation development cycle to measure and predict the performance of applications using the RTI.  These tools are designed to support risk mitigation on a local area network (LAN), to provide federation emulation across a wide area network, and to allow participants to test the network interoperability with a combination of emulation and actual simulations prior to the full-up exercise. [See 00S-SIW-098,  “Application-Specific Network Performance Analysis using the Navy's HLA Federation TestBed," for a discussion of the methodology applied in the testbed.] The HLA Federation TestBed is currently in the prototype development phase. One of the first WAN tests uncovered issues both with the network and with the RTI. This paper describes the configuration and lessons learned in conducting a HLA federation execution through a firewall on an unclassified network on the Defense Research Engineering Network (DREN).2.  HLA Federation TestBed Configuration The development plan for the HLA Federation TestBed describes federation execution between NUWC and NRL conducted using the DMSO RTI version 1.3v6.  A series of federates will be used but the initial federation consists of two HelloWorld federates, modified to allow in-line logging of all message traffic.  2.1  NetworkNUWC and NRL are connected via the DREN.  The DREN supports both classified (via cryptography devices) and unclassified network traffic.  Although NRL's unclassified network segment does not have a firewall in place, NUWC’s unclassified network segment does.  The firewall controls all remote interactions with the NUWC network, intercepting all network traffic.   To execute a federation, a “tunnel” through the firewall had to be constructed. A tunnel can be thought of as a point-to-point link between two trusted systems on opposite sides of the firewall.  The requirements for the tunnel had hardware, software, and security policy implications, as discussed in sections 3 and 4. 2.2   Initial Minimal System ConfigurationTwo unclassified PCs running RedHat( Linux 5.2 operating system were set up, one at NUWC in the Exercise Communications Center (ECC) and one at NRL.   A third PC running Windows NT( was set up in the NUWC ECC for use in observing and collecting data on network traffic.3.  Implementing a Multicast TunnelAfter initially determining that the RTI and HelloWorld were properly configured and working at each site and that an intra-site federation execution could be run, the process of configuring and testing the inter-site network began.  From the beginning, it was understood that HLA RTI uses a multicast protocol for data transfer between established federates.  Therefore, the initial effort was directed at creating a multicast tunnel through the NUWC firewall.3.1  What is a Multicast TunnelMulticast is an experimental protocol that can be thought of as a pared down broadcast tree.  With multicast, packets are sent to a multicast group address.  Hosts that want to receive multicast packets subscribe to be members of the multicast group.  Unlike broadcast packets, which are sent to all systems on a network and can be blocked or passed by routers only in a wholesale fashion, multicast packets are forwarded through multicast routers that serve systems subscribed to the multicast group.A multicast tunnel is a point-to-point link between two multicast routers located anywhere on a network.  The multicast packets are re-packaged by the send side of the tunnel to look like normal unicast packets and are forwarded.  When the packets reach the other side of the tunnel, they are stripped back to their original state and sent to all registered multicast group members.This tunneling mechanism acts as a virtual network, independent of the physical network, but only for the use of multicast traffic.Policy and Security ConcernsWorking with NUWC network administration, the HLA Federation TestBed team at NUWC needed to address several levels of policy and security concerns. First, one multicast tunnel, which was used intermittently, already existed through the firewall.  The network administrators investigated the possibility that the two tunnels could adversely affect each other and determined that, with proper precautions, they should not.Second, no procedure for obtaining permission to construct a tunnel existed.  The multi-level security on the DREN complicated this issue, although a waiver was required for breaching the firewall on the unclassified network only.  Interim procedures were adopted that defined the conditions under which the multicast tunnel could be used.  The testbed and network administration team is still working on a more formal policy statement and procedure.Third, the effect that the additional traffic would have on the NUWC network in general was investigated.  The unclassified network inside NUWC is used for day to day administrative and technical traffic.   NUWC network administration decided the best solution was to isolate the multicast traffic within the ECC so it would not flood the NUWC network.  To accomplish this, they created a small subnet within the ECC.With the policy decisions made and a subnet established at both NRL and NUWC, the multicast tunnel between the two subnets was implemented.3.3  Network Setup for the Multicast TunnelA trusted point-to-point connection between the NUWC ECC subnet and the NRL subnet was established by designating one system on each subnet to be the ends of the tunnel.  For the NUWC ECC side, a Cisco router (2611) was set up to isolate the multicast traffic on the NUWC network and act as the NUWC end of the tunnel.  This router, external name Bossie, was set up with two internet connections, one connecting the NUWC ECC subnet to NRL using the DREN, and the other connecting the NUWC ECC subnet to the NUWC network.  This router was then configured to enable multicast between the NUWC ECC subnet and the NRL system designated as the tunnel end.  At the NRL end of the multicast tunnel, a UNIX-based workstation, external name eagle, was configured to act as a multicast router by configuring the mrouted daemon in UNIX. An example of the mrouted configuration file is shown as follows:metric is a count of the number of route segments that the multicast packet will traverse; it defaults to 1.  threshold is the minimum time-to-live, designated in number of route segments, that a multicast packet will exist; this also defaults to 1.  These defaults were used for both ends of the tunnel and experiments proved they did not need to be increased. Figure 1 shows a representation of the NUWC-to-NRL network multicast tunnel configuration.4.  Additional Changes to the FirewallDuring configuration tests of the tunnel and RTI data transfer across the tunnel, it was determined that the RTI also sends TCP/IP traffic during the registration process.  TCP/IP is used for all reliable traffic, while multicast is used for best effort traffic.  The NUWC-to-NRL multicast tunnel would provide an avenue for the multicast data, but not the TCP/IP traffic.  In order for the federates to set up a federation, the NUWC firewall needed to allow TCP/IP traffic between the two subnets. 4.1  Policy and Security ConcernsA process similar to the process to receive the original multicast tunnel waiver was initiated to request the additional waiver to breach the firewall with TCP/IP traffic.  NUWC network security developed a security threat assessment.   The assessment resulted in a waiver with the following limitations.   The waiver was granted for 90 days.  As a condition for making the waiver permanent, the HLA Federation TestBed team was to identify a limited number of TCP/IP port numbers that could be used during HLA federation execution.  The port number limitation was used to further control the threat to NUWC security.Under the waiver, the testbed team guaranteed to disconnect all network connectivity to the trusted system at NUWC during non-working hours4.2  Network Setup for the TCP / IP ConnectionA UNIX-based workstation in the ECC, external name o2ecc1, was used to act as the RTI gateway to the NUWC/ECC network and a trusted network relationship was created between this workstation and eagle at NRL.5.  RTI Configuration of Reliable DistributorsThe RTI manages TCP connections between what are called reliable distributors and TCP clients, that is, the rtiexec, fedex and all federates. For a federate to connect to the federation through the firewall, the trusted systems at the ends of the tunnel, o2ecc1 and eagle, must each have a reliable distributor process started. A federate can then be configured to specifically look for these reliable distributors and to connect to that process at the end of the tunnel where the federate is located.  Once this connection is made and multicast is enabled, the two reliable distributors will forward messages across the firewall.  For example, the rtiexec process is started at NUWC on o2ecc1 and then the fedex process is started at NRL on eagle to connect to the rtiexec on o2ecc1.To implement this strategy the RTI rid files required some re-configuration.  The trusted systems, that is, the systems at each end of the tunnel that have an open TCP/IP connection through the firewall, were configured as reliable distributors and used as connection points for the exercise.   The client systems on the LAN subnets had to be configured to look to the reliable distributors for connection to the rtiexec and fedex  processes. During the process of configuration, it was found that the rid files on the two types of systems had to be configured differently. 5.1  Configuration of The Trusted SystemsFor the trusted systems, the rid files needed the auto reliable distributor option on, and the auto discover option off.  The rid file changes required on these systems are as follows:5.2 Configuration For Client SystemsClient systems include the systems on the LANs behind the trusted systems at both ends of the tunnel.  On these systems, the changes to the rid file needed the auto reliable distributor option off and the auto discover option on, and the trusted systems on the tunnel ends needed to be added as forced discoveries.  For the forced discoveries section the trusted host’s TCP/IP address is listed along with the RTI exec port number, and a discovery string, which can be blank.  An example of the rid file changes required on these systems are as follows, where IP_ADDRESS1 and IP_ADDRESS2 are the IP addresses of the trusted systems at the ends of the tunnel.Both trusted systems can be listed under forced discoveries; however, it is more efficient to list only the trusted system on the same LAN as the client system.  Since the federate will try to discover each system listed, the federate connect time could take longer if both are searched for.6.  Verifying the Multicast Tunnel ConfigurationThere are several ways of verifying the multicast tunnel configuration, depending on whether the tunnel is configured on a router or a UNIX system.  CISCO RouterFor a CISCO router, the team found the following commands useful in verifying the tunnel configuration and collecting additional tunnel related network data.  Table 1.  CISCO Router CommandsCommandOperationmtrace <address>Shows the path to the address and backmstat <address>Shows multicast statistics to the address and backshow ip mcacheShows IP addresses that are on the tunnelshow ip mrouteShows all multicast routes currently configuredshow ip routeShows all networks the router supports6.2  UNIX WorkstationUnder UNIX each vendor implements different commands to view multicast configuration information.   On the SGI workstation used on NRL's end of the tunnel, running the mrouted daemon also supports the mtrace command and the multicast router daemon provides a listing of the multicast configuration in the file /var/tmp/mrouted.dump. 7.  Lessons Learned and RecommendationsDuring the process of setting up the network, several difficulties and issues became evident, requiring changes in the initial plan and delays in implementation.7.1  RTI rid File ChangesThe out of the box RTI rid files did not work under our network configuration. DMSO help desk made several suggestions, which pointed us in the right direction but did not directly solve our problem. The solution described in this paper required the rid files to be set differently depending on the system's responsibility in the federation.  The changes to the rid files are dependent on the network setup and required time to experiment.  RTI Network RequirementsThe DMSO RTI 1.3v6 uses both TCP/IP and multicast protocols.  The firewall tunnel needed to be defined to support both. Both requirements were misunderstood during early federation development.  The effects of this misunderstanding are still being felt.7.3  Network Management InvolvementNetwork managers at both sites need to be involved early in the process.  Their knowledge and understanding of the LAN configurations and network protocols was invaluable during the troubleshooting phase of the configuration.Their network sniffing tools helped determine which side of the tunnel was functioning improperly. Network administration and security approvals require time.  The increasing need for and dependence on firewalls will undoubtedly increase this procedural burden.Since the multicast protocol is experimental, the network managers needed time to determine the possible impact of the HLA Federation TestBed operation on other users of the WAN and LANs.7.4  Network Segment SwitchingNetwork switching segments also needed to be understood and to be compatible. On both sides of the multicast tunnel, workstations and routers on switched segments of the network cause problems.  At NUWC, difficulties were found when the workstation in the ECC used to monitor network traffic was on a separate switched port than the router.  As a result, the monitor did not receive all traffic going through the router, because the switch passed only certain traffic from the federation subnet.  Once the workstation was moved to the same switching segment as the router, the workstation could see the traffic on that segment of the network.A similar difficulty arose on NRL’s side of the multicast tunnel.  The first workstation used as a trusted system was on an Asynchronous Transfer Modes (ATM) segment of that network and could see only a subset of the traffic being sent.  When the tunnel was moved to a workstation that was not on the ATM segment of the network, the tunnel functioned properly.Network sniffer tools were instrumental in isolating these problems.  The NUWC ECC network used a Window NT workstation running the tool EtherPeek from AG Group to monitor network traffic.7.5  Multicast and Network Card Driver Support The newest network card driver should be used. Full multicast support by the vendor is critical.Once the multicast tunnel was configured and verified, the team began running various exercises across the tunnel.  The team ran the DMSO tools provided with the RTI, such as HelloWorld, on the tunnel ends and the client workstations with apparent success. The DMSO BmLatency benchmark also ran successfully. BmThruput, however, would crash at different stages when the federate at NRL would send data to the Linux (w71hlatest2) system at NUWC.  Analysis of the Linux system log /var/log/message showed that the Ethernet card was experiencing timeouts during the multicast stages of the exercise.  On further investigation, it was discovered that some implementations of ethernet card drivers for Linux only provide partial multicast support.  A new driver for the system's network card was downloaded and installed, which appears to have corrected this problem.The Linux network card driver not completely supporting multicast took the team by surprise.  The system had been running for several months, participating various HLA exercises. The system would always connect to the fedex process.  While it had dropped completely off the network five or six times over three to four months, and always after multicast packets were being sent, the failure was not demonstrated consistently.  Also, no network interrupt errors were displayed to the system console, and the commands to report network status would display as if the system were behaving normally.  8.  ConclusionThe HLA Federation TestBed is designed to help the Navy identify the issues that affect the execution of a federation and to support faster, better, cheaper configuration of a federation.  The experiences in configuring this simple federation emphasize the need for procedures to mitigate the risks to larger exercises.The experimentation with the rid file should have been unnecessary. Firewalls are a fact of life, and trusted system connecting independent subnets will be needed for most distributed executions.  Procedures and / or an explanation of the requirements for such configurations should be readily available. The procedures described here should be applicable to similar firewall tunnels.  The configuration of the multicast tunnel took far longer than anticipated.  Some of the delays should have been anticipated, particularly the time needed to plan, get approval, and coordinate the multicast tunnel configuration between the two sites.   Scheduling these activities and involving the network and security personnel early will ensure a smoother configuration. Author BiographiesGERALD M. SANTOS is Navy Deputy for the OSD Foundation Initiative 2010. He has led testing of interoperability between the virtual torpedoes of the hardware-in-the-loop Weapons Analysis Facility (WAF) and real submarines on the AUTEC Range using HLA and its T&E community extensions.JOHN M. REPKO II is a computer engineer at the Naval Undersea Warfare Center and is a recent graduate of The Pennsylvania State University where he obtained a Bachelor of Science in Computer Engineering.CYNTHIA DRESCHER ARCHAMBAULT is a Senior Program Analyst at Logicon Inc, a Northrop Grumman company, and is under contract with the Naval Undersea Warfare Center for the HLA Federation TestBed Prototype.mrouted <local_address> <remote_address> metric 1  threshold 1auto_reldistr_config 1auto_discover_on 0auto_reldistr_config 0auto_discover_on 1reldistr_forced_discoveries:	(<IP_ADDRESS1> 5996 “”)	(<IP_ADDRESS2> 5996 “”)Figure 1.   HLA Federation TestBed Wide Area Network