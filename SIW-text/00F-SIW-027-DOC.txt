The Environmental Tailoring SystemPeter S. Dailey, Ph.D.Robert A. ReynoldsTASC, Inc.55 Walkers Brook DriveReading, MA 01867-3297781-942-2000, Fax 781-942-7100 HYPERLINK mailto:psdailey@tasc.com psdailey@tasc.com,  HYPERLINK mailto:tahutchinson@tasc.com rareynolds@tasc.comKeywords:Synthetic Natural Environments, User-controlled Weather, Environmental TailoringABSTRACT:  The Environmental Tailoring System (ETS) is a software tool for editing digital representations of the Synthetic Natural Environment (SNE), with emphasis on the atmospheric component.  ETS will provide a means by which distributed simulation exercise participants can edit environmental data either prior to an exercise or during run-time.  Through the JETS (JSIMS Environmental Tailoring Services) research effort, sponsored by the Advanced Simulation Technology Thrust (ASTT) program, an algorithm has been developed which allows for physically consistent tailoring of selected environmental parameters.  The Pressure Field Modification (PFM) scheme accepts user inputs such as edit variable, edit value, and the spatial and temporal extent of the edit, and makes these modifications to the data while preserving a scientifically valid correlation between atmospheric variables.Under the JETS II follow-on effort, the results of the JETS research have been extended to include a graphical interface which allows for specification and management of edits and execution on existing atmospheric databases prior to an exercise.  In addition, a synchronized visualization system allows users to simultaneously examine pre- and post-edit fields after modifications have been applied. Current research is extending the editing tools further, adding precipitation as a new editable parameter, and implementing PFM in a run-time mode.This paper will highlight (a) an overview of the PFM editing algorithm developed under JETS, (b) a new feature which allows for tailoring of precipitation, and (c) approaches to cloud editing using ETS in conjunction with the Environmental Data Transformer (EDT, a related application under development).1. IntroductionThere is a need within the Modeling and Simulation (M&S) community for tools that give exercise managers the ability to modify the state of the simulated natural environment (i.e, “dial the weather”).  Such tools are perceived as critical to maximizing the value of the training experience [1,2].  There are a variety of situations that motivate changes to the synthetic natural environment (SNE), but in general, they can be grouped into two categories: pre-exercise and run-time tailoring.In pre-exercise tailoring, the goal is to tune an environmental scenario such that it matches, as closely as possible, known training objectives.  For example, it may be important that between 14Z and 16Z on the second day of the scenario, there be no clouds or precipitation to thwart air-borne sensor detection of ground targets.  But, the scenario, which is derived from environmental data archives, has overcast skies between those hours.  Using an editing tool, the clouds can be removed from the scenario within the desired interval.  In this way, pre-exercise editing tools add value to pre-computed SNE databases.In run-time tailoring, the goal is to modify the SNE in order to steer the exercise toward a desirable outcome or to bridge unanticipated problems encountered during the exercise.  The motivation for such a tool is that prior to an exercise it is impossible to determine exactly how events will unfold.  When during the exercise the synthetic environment is impeding desired progress in the simulation, the SNE can be modified so the exercise can progress in a manner consistent with achieving desired training.Whether pre-exercise or during run-time, SNE tailoring should retain an appropriate level of fidelity.  In the past, “block editors” have allowed for the replacement of a block of data with a single replacement value [2].  Block editing can be useful in that it is both simple and efficient, but resultant abrupt changes that occur at the block edit’s interface with the unedited SNE are physically inconsistent and uncorrelated.  Using block editing, it is the user’s responsibility to assure that changes to the SNE are made physically consistent.  Correlated editing tools have recently made their way into the M&S toolbox [5].  For example, the Pressure Field Modification tool is being incorporated into M&S as a more physically realistic approach to SNE tailoring.This paper will discuss the basis for the Pressure Field Modification algorithm and its use in the Environmental Tailoring System (ETS).  Section 2 highlights the main features of PFM.  In Section 3, recent enhancements to the algorithm to support precipitation editing will be discussed.  Section 4 focuses on the use of the Environmental Tailoring System (ETS) in conjunction with the Environmental Data Transformer (EDT).  Both ETS and EDT are components of the Ocean Atmosphere and Space Environment System (OASES) being developed under Defense Modeling and Simulation Office (DMSO) sponsorship.  Finally, Section 5 offers a conclusion.Overview of Pressure Field ModificationThe Pressure Field Modification (PFM) algorithm was developed under the Defense Advanced Research Projects Agency (DARPA) program named the Advanced Simulation Technology Thrust (ASTT).   Under the JSIMS Environmental Tailoring Services (JETS) ASTT effort, editing algorithms, including the PFM scheme, were researched and defined. PFM is designed to allow users the ability to change SNE data at a specific time and location.  When executed to affect the desired change, PFM maintains an appropriate level of scientific validity for the scenario as a whole.  This requires modification to other SNE variables in order to maintain proper correlation between variable.  This type of automated correlation is not available via block editing.The basic PFM concept is to determine how the requested edit impacts the atmospheric pressure field, and use that pressure perturbation to compute the impact of the edit on other atmospheric variables in the SNE.  PFM has been well documented in previous papers [3, 4, 5], so the purpose in this section is simply to summarize the process by which PFM modifies an SNE.The PFM algorithm works as follows.  The user specifies a variable to be changed, such as temperature.  To fully define the edit, the user specifies a new value for temperature, an interval of time over which that value is to be blended, and the spatial extent of the edit.  The algorithm first spatially blends the temperature over a “region of influence”.  Then, a pressure perturbation corresponding to the edit is calculated.  Next, using this change to the pressure field, PFM adjusts the values of parameters correlated with temperature (e.g., humidity, wind) to make the edit physically consistent. Finally, the edit is blended in time and correlated changes to other variables are computed for the entire “period of influence”.  The result is a 4-D data set that is internally consistent, and achieves the user-requested atmospheric state at the specified time and place.  Figure 1 provides a schematic view of the algorithms functionality.The larger the region of influence and the longer the period of influence, the less the edit is “felt” at any given point.  For example, a temperature edit which is blended over 10 hours of simulation time will evolve much more gradually than the same edit blended over just 3 hours.  Blending can be used, especially prior to an exercise, to create a subtle transition into an edited portion of the database.  It should be noted that during the exercise, a lack of “lead time” might preclude an appropriate amount of temporal blending prior to the edit time.  In general, this will be of little consequence to the exercise directors or participants as the prior time will have already been passed in the simulation.  At worst, the abrupt introduction of the changed state could influence some sensor models adversely if performing calculations across the time boundary of the edit.Under the JETS follow-on effort (JETS II), PFM was implemented and a Graphical User Interface (GUI) was designed to allow for interactive specification of edits.  The GUI allows users to specify the edit location and value, as well as the spatial and temporal extent of the edit.  Once one or more edits are specified, PFM is executed on an existing SNE database, and a new edited database is written to disk.  The interface is shown in Figure 2.A dual-synchronized visualization system was also designed under JETS II to give the user a view of the SNE “before” and “after” editing using PFM.  Display widgets control both panels simultaneously, allowing the user to examine three-dimensional impacts of specified edits.  Figure 3 shows the synchronized display with an example of relative humidity edited at the center of the domain.Each of these software components, the graphical interface and the dual visualizer, are being incorporated into ETS.  Functionality will be extended to include a block editing capability that takes advantage of existing PFM code.Figure 2 – Graphical User Interface (GUI) for the Environmental Tailoring System (ETS).  Users specify edit locations and variable, spatial extent, and temporal extent.  The GUI saves the edit specification in a configuration file and the PFM algorithm uses that configuration file to execute edits on an SNE.Figure 3 – The ETS dual-synchronized visualizer.  The top display panel shows the pre-edit SNE database.  The bottom display shows post-edit data.  GUI controls manipulate both displays simultaneously.Precipitation Enhancement to PFMIn JETS and JETS II, PFM focused on tailoring set of fundamental atmospheric state variables including pressure, temperature, wind, and humidity.  For ETS, PFM has been enhanced to accept edits to precipitation, a much more complex environmental parameter.  Because precipitation is so closely tied to the development of clouds in the atmosphere, any precipitation editing scheme for PFM must pay particular attention to the existing algorithmic components that relate to clouds.  At this point in its development, PFM is designed to accept edits to relative humidity (RH) rather than clouds themselves.  If a user desires cloud cover over a certain region and at a particular height level, he can request an increase in RH and blend it over the desired area.  Then, using transformations that derive cloud parameters from RH profiles, a new cloud field can be obtained (see complete discussion in Section 4).In order to provide a precipitation editing capability, PFM must first analyze the presence or absence of clouds over the edit region before addressing precipitation itself.  For example, if the user requests a rain rate of 1 mm/hr at a location over which clouds do not exist, PFM must first “create” clouds at that location and then edit the precipitation rate accordingly.  Since PFM already embodies the algorithms for RH editing, these components can be reused by internally specifying an edit to RH that is consistent with the desired precipitation edit.Editing precipitation involves several steps, each of which takes advantage of existing PFM features.  Precipitation differs from other editable fields in PFM in that (a) it is a two-dimensional (XY) field, and (b) its manipulation, by definition, involves a simultaneous change to the cloud and moisture fields.  Because this edit is two-dimensional, the user specifies an X and Y radius of influence defining an ellipse of influence (rather than a 3-D ellipsoid).  In contrast to other editable fields, the steps involved in modifying an SNE for precipitation proceed in the following order: modify precipitation rate at the edit location blend that edit in time according to the temporal period of influenceinternally specify cloud (RH) edits using the 3-D capabilities of PFM based on edited precipitation values for all edit timescorrelate the edited 3-D RH fields with the remainder of the SNE at the edit time and across the edits temporal and spatial extentsperform a post-processing step whereas precipitation is modified (in 2-D) at all locations beneath the 3-D internally specified RH ellipsoidA schematic referencing these five steps is shown in Figure 4.  It is helpful to refer back to this figure while reading the following subsections.Modifying precipitation rateBefore any changes are made to precipitation values, an atmospheric assessment is made.  In this assessment, the mean and standard deviation of precipitation rate (PR) are determined at the edit time for the entire spatial domain.  This provides a simple way of relating the requested edit to “local climatology” without the storage requirements of large climatological databases.  Using these statistics, we can characterize the local “severity” of the requested edit.  “Severity” is defined as the number of standard deviations the edit lies from the domain mean.  Low edit severity indicates a small change to the pre-existing SNE.  Note that edit severity could be used to alert a user that configurable statistical constraints are being broken.  For example, a warning might appear if edit severity exceeds 4 (> 4 from the mean).  Though this constraint feature is not yet implemented in PFM, it could eventually provide useful guidance to the user.Also, as a part of atmospheric assessment, the Lifted Index parameter is computed at the edit time using vertical profiles of temperature and moisture above the edit location.  Lifted Index is widely used in the meteorological community to forecast the likelihood of convective (unstable) activity.  The index is defined as:LI = T500 – Tp1000where T500 is the ambient temperature at the 500 mb pressure level and Tp1000 is the temperature of an air parcel lifted to the 500 mb pressure level from the 1000 mb level [6].This stability parameter will assist in determining the vertical and horizontal extent of a cloud consistent with the desired precipitation rate.3.2  Blending precipitation rate in timeThe “period of influence” defines the time over which the PR is to be blended.  If the period of influence is six simulation hours, for example, the edit will evolve in three simulation hours and then fade away over three simulation hours. The requested precipitation value replaces the PR at the edit time, and new blended PRs replace rates at times within the period of influence.  Of course, the farther away an edit is in time, the less its impact at that time.  Specifically, the temporal weighting function that is applied is expressed as a linear function of time from the time of the edit.  Pre-existing PRs are not ignored.  Rather, they are supplemented with new rates resulting from the blending process. Internally specifying relative humidity editsUsing information obtained in the atmospheric assessment, the relative humidity (RH) field is modified at all edit times by specifying a RH edit based on the modified precipitation rate at the edit location.  This internally specified RH edit is based on the edit severity and atmospheric stability parameters determined in atmospheric assessment.  Specifically, the RH edit will be centered at a location above the PR edit location at the height of maximum RH.  The horizontal and vertical radii of influence are determined based on the Lifted Index parameter.  The more unstable the environment, the more vertically oriented the cloud will be.  Note in Figure 4, the size and shape of the RH ellipsoid may be different at different times since stability changes during the simulation.There are three cases of RH modification: (1) cloud and precipitation existed prior to the edit, (2) cloud existed prior to the edit, but precipitation did not, and (3) neither clouds nor precipitation existed prior to the edit.  Depending on which situation exists in the original data, the RH edit may be used to create a new precipitating cloud, or may alter an existing cloud such that it precipitates.The underlying assumption made in this step is that increasing liquid moisture content in the atmosphere results in a cloud that is more likely to precipitate.  It is known that increasing the presence of cloud droplets and the level of relative humidity within the cloud increases the likelihood that a cloud will release precipitation [7].  Of course, the microphysical process has been greatly simplified for the purpose of ETS.  More sophisticated Numerical Weather Prediction (NWP) models typically predict the conversion of cloud water to rain water over time using an “autocoversion rate”.  Thus, NWP models accumulate rain water (and other types of precipitation) in clouds over time.  Since PFM modifies clouds and precipitation simultaneously and changes are made at a single time, the process has been further parameterized for ETS.Correlating edited relative humidity with related SNE variablesThe internal specification of RH edits is based on the pre-edit cloud field as well as the atmospheric assessment made above.  Once the RH field has been modified at all edit times to reflect the altered precipitation fields, the PFM scheme for correlating the RH edit with the rest of the SNE is executed.  Details related to the editing of RH can be found in [3].At this point in the editing process, a precipitation edit at all times within the period of influence but only at the edit location has been completed.  In addition, a set of RH edits within the entire edit ellipsoid and at all edit times has been specified and correlated with the rest of the SNE (see Figure 4).3.5  Blending precipitation rate in spaceAfter completing the modification and correlation steps (1 – 4), the SNE is internally consistent at all edit times and in all three-dimensions to reflect the requested precipitation edit.  The only field that remains uncorrelated is precipitation surrounding the edit location.  Since the cloud field in the atmosphere above the edit has been altered, the original precipitation field must be correlated with the newly modified 3-D moisture field.  This final step is called back-end precipitation field processing.  Here, using the edited RH field, new precipitation values are calculated.  This back-end step is useful in that it allows for a realistic spatial blend of precipitation values surrounding the edit location while preventing the need for a recursive cloud edits based on an explicitly blended precipitation rate.  That is, precipitation is blended based on a cloud field which reflects the user edit to precipitation at a single location.  This is in contrast to the more complex process of creating a series of RH and cloud edits that properly correlate with a spatially blended precipitation.  For this reason, spatial blending of precipitation is the final step (see Figure 4) in the PR editing process.Using the original and adjusted RH profiles, new precipitation rates are computed for each location within the edit ellipse.  The equation used to determine the blended precipitation rate is: EMBED Equation.3  where:PRe = edited PR at the blended edit locationPRo = original PR at the blended edit locationPRa = adjustment to the PR at the blended edit location and bRH and cRH are computed relative changes to RH in a column lying above the blended and edit locations respectively.For example, assume the requested adjustment to precipitation at the edit location is to increase it rate by 2 mm/hr.  If the edit location has an adjusted RH percentage of +10% and the adjoining location has an adjusted RH percentage of +8%, the new precipitation rate for the adjoining location will be 1.6 mm/hr.  This PR is 20% less than the PR at the edit location, corresponding to the ratio of adjusted RH.  Note that if precipitation were already present at the adjoining location, the original rate would be added to 1.6 mm/hr.4.  Using ETS in conjunction with EDTThe Environmental Data Transformer (EDT) is an application that allows for the creation of derived variables from a pre-existing SNE.  Once new variables are created using EDT, they become a permanent part of the environmental database.A simple example of an EDT transform is wind speed.  Many numerical models used to create M&S scenarios output wind in its component directions u (E-W wind) and v (N-S wind).   Similarly, u and v are the wind fields supported by PFM editing in ETS.  In order to obtain scalar wind speed from its u and v components, a simple transformation is made in EDT:wind speed EMBED Equation.3  We can use EDT in conjunction with ETS to examine the impact of a tailored variable on derived fields.  An illustrative example is the use of ETS to modify RH and the subsequent use of EDT to derive cloud parameters based on the edited RH field.A user might desire an increase in cloud cover over a tactical area.  He proceeds by specifying an edit to RH, an edit region over which cloud cover is desired, and a temporal period of influence.  ETS creates a new RH field within the edit ellipsoid and edits all correlated state variables at SNE times contained in the ellipsoid and period of influence.  But, how much cloud coverage does the new RH field provide?  To examine this, the user can create cloud parameters using EDT.  EDT currently contains transforms for cloud base, cloud top, and cloud type, all derived from vertical profiles of temperature and RH [6].This coupled approach is particularly useful when a variable (e.g., cloud base) is not available to ETS as an edit variable, but the parameters from which it is derived (e.g., temperature, RH) are available to ETS.Ultimately, it would be helpful to tie existing transforms to ETS editing capabilities directly.  For example, if there is a transform which uses temperature and moisture to derive visibility, it would be helpful for PFM to accept a direct edit to visibility itself, and internally specify edits to temperature and moisture which will bring about the desired change.  This type of coupling implies a process analogous to the editing of precipitation via specification of RH edits.  It would add a good deal of complexity to ETS as well as hamper its efficiency, but may be a useful long-term enhancement.5.  ConclusionIn this paper we have highlighted the Pressure Field Modification algorithm and its use in the Environmental Tailoring System.  Software components developed under the JETS effort, such as the specification GUI and the visualizer, will be reused in ETS.For ETS, the PFM algorithm has been enhanced with precipitation editing capability.  The use of PFM to edit precipitation is complex, and involves an editing technique that differs from the standard PFM approach.  Specifically, by implementing spatial blending as a back-end process, precipitation editing is made efficient and realistic.The Environmental Tailoring System can be used in conjunction with the Environmental Data Transformer to examine derived variables that are impacted by modifications to the SNE but are not directly available to PFM.  This can be particularly useful when PFM does not edit a derived variable directly (e.g., cloud base), but yet has tactical significance to the exercise.6.   References[1]	Whitney, D. A., et al.: “TAOS: Providing and Managing Realistic Natural Environments for Virtual Worlds”, Proceedings of the Fall Simulation Interoperability Workshop, September 1997.[2]	Whitney, D. A., et al. “Virtual Natural Environments for the 21st Century”, Proceedings of the I/ITSEC Conference, 1998.[3]	Dailey, P. S., et al., “Algorithms for Consistent Tailoring of the Synthetic Natural Environment”, Proceedings of the Fall Simulation Interoperability Workshop (SIW), September, 1998.[4] Dailey, P. S., et al., “Status Report: JSIMS Environmental Tailoring Services (JETS) Tailoring Algorithms and Framework Assessment”, Proceedings of the Spring Simulation Interoperability Workshop (SIW), March, 1999.[5]	Dailey, P. S., T. A. Hutchinson, and Steve O. Ouzts, “Tools for Tailoring the Synthetic Natural Environment,” 16th International Conference: Interactive Information and Processing Systems (IIPS) for Meteorology, Oceanography, and Hydrology, Amer. Meteor. Soc., Long Beach, CA, January, 2000.[6]	The Global-98 METOC Database, Defense Advanced Research Projects Agency (DARPA) Defense Modeling and Simulation Office (DMSO) Release 2, September, 1999, DACA76-94-C-0021.[7]	Ahrens, C. D., Meteorology Today, West Publishing Co.,  4th Edition, 1991, p. 217.AcknowledgmentsThis work is sponsored by the Defense Modeling and Simulation Office (DMSO).  JETS work was sponsored by the Defense Advanced Research Projects Agency (DARPA) under the Advanced Simulation Technology Thrust (ASTT) program.  JETS II work was jointly sponsored by DARPA/ASTT and DMSO.Author BiographiesPETER S. DAILEY is an atmospheric scientist and the technical lead for atmospheric data integration on the EnviroFed II project. Dr. Dailey has expertise in atmospheric modeling, numerical weather prediction, and algorithm development.  Dr. Dailey received a B.A. and B.A.S. from the University of Pennsylvania, and a M.S. and Ph. D. from the University of California at Los Angeles.ROBERT A. REYNOLDS is a Principal Member of the Technical Staff at TASC and has been the system architect and lead developer for TAOS (and its successor, OASES) through the STOW-97/98 program, the PSM+ program, and the ongoing EnviroFed project.  His professional interests are focused in the areas of software engineering, object-oriented modeling, visualization, distributed simulation and synthetic environments.  He has a BS degree in Physics from the Massachusetts Institute of Technology and an MS degree in Nuclear Engineering from Carnegie-Mellon University. Actually, there are three radii of influence, one for each spatial direction. The user specifies radii over which to blend the edit in the N-S direction, the E-W direction, and above and below the edit.  Radii are defined in kilometers from the edit location.  The result of this spatial definition is an “ellipsoid” which defines the edit region.  Outside the ellipsoid, all SNE data remains unchanged. The “PR edit ellipse” is the 2-D elliptical projection onto the surface of the 3-D RH ellipsoid.  Because ellipsoids may have different shapes,  the region over which PR is modified may vary in shape at different SNE times (see Figure 4).RHRHRHSiSiSiRHRHRHTE+tTETE-t2-D PR field spatially blendedTE+tTETE-tEdit other 3-D SNE fields within RH ellipsoidTE+tTETE-tRH edits specified at all timesTE+tTETETE-tPR blended in timePR modified at edit locationSTEP 5:Modify PR at all locations below the internally specified RH ellipsoidSTEP 4:Correlate edited RH field with correlated  SNE fields at all edit timesSTEP 3:Internally specify RH edits based on PR edit  for all edit timesSTEP 2:Blend edit in time according to temporal period of influenceFigure 4 - Schematic showing the process by which precipitation editing is executed in PFM.  TE is the time of edit.  TE-t and TE+t are other SNE times within the period of influence.  Si designates 3-D SNE fields other than relative humidity. STEP 1:Modify precipitation rate (PR) at the edit locationFigure 1 - Schematic showing the functionality of PFM.  After the user defines an edit, PFM calculates perturbations to correlated SNE variables and then applies the edit, blending in time and space.PFM processes edit-- Modify edit variable at specified time and location-- Blend edit in space and compute correlated changes to SNE-- Blend edit in time and compute correlated changes to SNEPFM computes correlationPFM calculates pressure perturbation based on edit, then correlates it with other variablesUser specifies edit-- Variable and value-- Spatial “ellipsoid of influence”-- Temporal “period of influence”